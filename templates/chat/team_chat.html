{% extends 'base.html' %}

{% block body_class %}chat-page{% endblock %}

{% block title %}Team Chat - CTF Platform{% endblock %}

{% block extra_head %}
<meta name="robots" content="noindex, nofollow, noarchive, nosnippet">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/teams.css?v={{ request.GET.t|default:'1' }}">
<link rel="stylesheet" href="/static/css/chat.css?v={{ request.GET.t|default:'1' }}">
{% endblock %}

{% block content %}
<div class="container">
  <div class="row mb-2">
    <div class="col-md-12">
      <div class="chat-top-bar">
        <div class="current-user-indicator">
          <i class="fas fa-user-circle"></i>
          <strong>Logged in as:</strong>
          <span class="username-badge">{{ user.username }}</span>
          {% if is_captain %}
          <span class="captain-badge">üëë Team Captain</span>
          {% endif %}
        </div>
        <div class="team-nav-buttons">
          <a href="{% url 'teams:team_detail' team.id %}" class="btn-team primary">
            <i class="fas fa-arrow-left"></i> Back to Team
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-9">
      <div class="chat-container">
        <div class="chat-header">
          <i class="fas fa-comments"></i> Team Chat
          <span class="float-end">
            <small>{{ messages|length }} messages loaded</small>
          </span>
        </div>

        <div class="chat-messages" id="chat-messages">
          {% for message in messages %}
          <div
            class="message {% if message.sender == user %}own-message{% endif %} {% if message.message_type == 'system' %}system-message{% endif %}"
            data-message-id="{{ message.id }}" data-sender="{{ message.sender.username }}"
            data-current-user="{{ user.username }}" data-can-edit="{{ message.can_edit }}"
            data-can-delete="{{ message.can_delete }}">
            <div class="message-content-wrapper">
              <div class="message-avatar">
                {% if message.sender.userprofile.profile_photo %}
                <img src="{{ message.sender.userprofile.profile_photo.url }}" alt="{{ message.sender.username }}"
                  style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                {% else %}
                {{ message.sender.username|first|upper }}
                {% endif %}
              </div>

              <div class="message-text-area">
                <div class="message-header">
                  <div class="message-info">
                    <span class="message-sender">
                      {% if message.sender == team.captain %}üëë{% endif %}
                      {{ message.sender.username }}
                    </span>
                    <span class="message-time">
                      {{ message.timestamp|date:"H:i" }}
                      {% if message.is_edited %}
                      <span class="edited-indicator">(edited)</span>
                      {% endif %}
                    </span>
                  </div>
                  {% if message.can_edit or message.can_delete %}
                  <div class="message-controls-right">
                    {% if message.can_edit %}
                    <button class="control-btn-wide edit-btn" data-message-id="{{ message.id }}" title="Edit message">
                      <i class="fas fa-edit"></i> Edit
                    </button>
                    {% endif %}
                    {% if message.can_delete %}
                    <button class="control-btn-wide delete-btn" data-message-id="{{ message.id }}"
                      title="Delete message">
                      <i class="fas fa-trash"></i> Delete
                    </button>
                    {% endif %}
                  </div>
                  {% endif %}
                </div>
                <div class="message-content">{{ message.content }}</div>

                <div class="message-footer">
                  {% if message.reactions.all %}
                  <div class="message-reactions">
                    {% regroup message.reactions.all by emoji as reactions_by_emoji %}
                    {% for emoji_group in reactions_by_emoji %}
                    <span class="reaction" data-emoji="{{ emoji_group.grouper }}"
                      title="{% for reaction in emoji_group.list %}{{ reaction.user.username }}{% if not forloop.last %}, {% endif %}{% endfor %}">
                      {{ emoji_group.grouper }} {{ emoji_group.list|length }}
                    </span>
                    {% endfor %}
                  </div>
                  {% endif %}

                  <div class="message-actions">
                    <button class="react-btn" data-message-id="{{ message.id }}">üòÄ</button>
                    <button class="react-btn" data-message-id="{{ message.id }}">ÔøΩ</button>
                    <button class="react-btn" data-message-id="{{ message.id }}">‚ù§Ô∏è</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% empty %}
          <div class="text-center text-muted py-5">
            <i class="fas fa-comments fa-3x mb-3"></i>
            <p>No messages yet. Start the conversation!</p>
          </div>
          {% endfor %}

          <div class="typing-indicator" id="typing-indicator">
            Someone is typing...
          </div>
        </div>

        <div class="chat-input">
          <form class="chat-input-form" id="message-form">
            {% csrf_token %}
            <input type="text" class="chat-input-field" id="message-input"
              placeholder="Type your message... (Press Enter to send)" maxlength="1000" autocomplete="off">
            <button type="submit" class="send-btn" id="send-btn">
              <i class="fas fa-paper-plane"></i> Send
            </button>
          </form>
          <small class="text-muted">
            üí° Tip: Use @username to mention team members
          </small>
        </div>
      </div>
    </div>

    <div class="col-lg-3">
      <div class="team-members-sidebar">
        <h5 class="text-primary mb-3">
          <i class="fas fa-users"></i> Team Members
        </h5>
        <ul class="member-list">
          {% for member in team_members %}
          <li class="member-item {% if member.username == team.captain.username %}captain{% endif %}">
            <span class="online-indicator"></span>
            {% if member.username == team.captain.username %}üëë{% endif %}
            {{ member.username }}
            {% if member.username == user.username %}<small>(You)</small>{% endif %}
          </li>
          {% endfor %}
        </ul>

        <div class="mt-4">
          <h6 class="text-primary">Quick Actions</h6>
          <div class="d-grid gap-2">
            {% if is_captain %}
            <a href="{% url 'teams:team_management' team.id %}" class="btn btn-sm btn-outline-primary">
              <i class="fas fa-cog"></i> Manage Team
            </a>
            {% endif %}
            <button class="btn btn-sm btn-outline-success" id="refresh-chat">
              <i class="fas fa-sync"></i> Refresh Chat
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let lastMessageTime = null;
  let isTyping = false;
  let typingTimeout = null;

  // Auto-scroll to bottom
  function scrollToBottom() {
    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  // Send message
  document.getElementById('message-form').addEventListener('submit', function (e) {
    e.preventDefault();

    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const content = messageInput.value.trim();

    if (!content) return;

    sendBtn.disabled = true;
    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

    fetch(`/chat/team/{{ team.id }}/send/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        content: content
      })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          messageInput.value = '';
          loadNewMessages();
        } else {
          alert(data.message);
        }
      })
      .catch(error => {
        alert('Failed to send message');
      })
      .finally(() => {
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send';
      });
  });

  // Load new messages
  function loadNewMessages() {
    const url = `/chat/team/{{ team.id }}/messages/` +
      (lastMessageTime ? `?since=${lastMessageTime}` : '');

    fetch(url)
      .then(response => response.json())
      .then(data => {
        if (data.success && data.messages.length > 0) {
          // Update messages (simplified - in real app you'd update DOM properly)
          location.reload();
        }
      })
      .catch(error => {
        // Silent error handling
      });
  }

  // React to message
  document.addEventListener('click', function (e) {
    if (e.target.classList.contains('react-btn')) {
      const messageId = e.target.dataset.messageId;
      const emoji = e.target.textContent;

      fetch(`/chat/message/${messageId}/react/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          emoji: emoji
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            location.reload(); // Simplified - in real app update reactions dynamically
          } else {
            alert(data.message);
          }
        });
    }

    // Edit message
    if (e.target.classList.contains('edit-btn')) {
      const messageId = e.target.dataset.messageId;
      const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
      const contentElement = messageElement.querySelector('.message-content');
      const currentContent = contentElement.textContent;

      const newContent = prompt('Edit message:', currentContent);
      if (newContent && newContent !== currentContent) {
        fetch(`/chat/message/${messageId}/edit/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            content: newContent
          })
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              contentElement.textContent = data.new_content;
              // Add edited indicator
              const timeElement = messageElement.querySelector('.message-time');
              if (!timeElement.querySelector('.edited-indicator')) {
                timeElement.innerHTML += ' <span class="edited-indicator">(edited)</span>';
              }
            } else {
              alert(data.message);
            }
          });
      }
    }

    // Delete message
    if (e.target.classList.contains('delete-btn')) {
      const messageId = e.target.dataset.messageId;

      if (confirm('Are you sure you want to delete this message?')) {
        fetch(`/chat/message/${messageId}/delete/`, {
          method: 'POST'
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              document.querySelector(`[data-message-id="${messageId}"]`).remove();
            } else {
              alert(data.message);
            }
          });
      }
    }
  });

  // Refresh chat
  document.getElementById('refresh-chat').addEventListener('click', function () {
    location.reload();
  });

  // Auto-refresh every 30 seconds
  setInterval(loadNewMessages, 30000);

  // Scroll to bottom on load
  document.addEventListener('DOMContentLoaded', function () {
    scrollToBottom();

    // Debug: Log current user and message permissions
    console.log('=== CHAT DEBUG INFO ===');
    console.log('Current logged-in user: {{ user.username }}');
    console.log('Is team captain: {{ is_captain }}');
    console.log('\nMessages and permissions:');

    document.querySelectorAll('.message').forEach(function (msg) {
      const msgId = msg.dataset.messageId;
      const sender = msg.dataset.sender;
      const currentUser = msg.dataset.currentUser;
      const canEdit = msg.dataset.canEdit;
      const canDelete = msg.dataset.canDelete;

      console.log(`Message #${msgId}:`);
      console.log(`  Sender: ${sender}`);
      console.log(`  Current User: ${currentUser}`);
      console.log(`  Is Own Message: ${sender === currentUser}`);
      console.log(`  Can Edit: ${canEdit}`);
      console.log(`  Can Delete: ${canDelete}`);
      console.log('---');
    });
    console.log('======================');

    // Prevent page from being cached in browser history
    if (window.history && window.history.replaceState) {
      window.history.replaceState(null, null, window.location.href);
    }

    // Clear any cached data on page unload
    window.addEventListener('beforeunload', function () {
      if (window.history && window.history.replaceState) {
        window.history.replaceState(null, null, '/teams/');
      }
    });
  });

  // Enter key to send
  document.getElementById('message-input').addEventListener('keypress', function (e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      document.getElementById('message-form').dispatchEvent(new Event('submit'));
    }
  });
</script>
{% endblock %}