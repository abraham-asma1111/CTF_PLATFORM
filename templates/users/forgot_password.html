{% extends 'base.html' %}

{% block title %}Forgot Password - CTF Platform{% endblock %}

{% block content %}
<div class="card" style="max-width: 500px; margin: 0 auto;">
  <div class="card-header">
    <h1 class="card-title">üîë Forgot Password</h1>
    <p>Enter your email or username to reset your password.</p>
  </div>

  <form method="post">
    {% csrf_token %}

    {% if show_verification %}
    <div class="form-group">
      <label for="id_identifier" class="form-label">Email/Username:</label>
      <input type="text" name="identifier" id="id_identifier" class="form-control" value="{{ identifier }}" readonly>
    </div>

    <div class="form-group" id="verificationSection">
      <label for="id_verification_code" class="form-label">Verification Code:</label>
      <div
        style="background: rgba(0, 255, 136, 0.1); border: 1px solid #00ff88; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
        <p style="color: #00ff88; font-size: 0.9rem; margin: 0 0 0.5rem 0;">
          üìß A 6-digit verification code has been sent to <strong>{{ email }}</strong>
        </p>
        <p style="color: #ff6b6b; font-size: 0.9rem; margin: 0 0 0.5rem 0; font-weight: bold;">
          ‚è±Ô∏è Code expires in: <span id="countdown">60</span> seconds
        </p>
        <p style="color: #ffa500; font-size: 0.85rem; margin: 0 0 0.5rem 0; font-weight: bold;">
          ‚ö†Ô∏è You have 3 attempts. After 3 failed attempts, you will be blocked for 15 minutes.
        </p>
        <p style="color: #999; font-size: 0.85rem; margin: 0;">
          üí° <strong>Development Mode:</strong> Check your terminal for the code if email is not received.
        </p>
      </div>
      <input type="text" name="verification_code" id="id_verification_code" class="form-control" placeholder="000000"
        maxlength="6" pattern="[0-9]{6}" required autofocus>
    </div>

    <button type="submit" class="btn btn-primary" id="verifyBtn" style="width: 100%;">Verify Code</button>
    {% else %}
    <div class="form-group">
      <label for="id_identifier" class="form-label">Email or Username:</label>
      <input type="text" name="identifier" id="id_identifier" class="form-control"
        placeholder="Enter your email or username" required autofocus>
    </div>

    <button type="submit" class="btn btn-primary" style="width: 100%;">Send Verification Code</button>
    {% endif %}
  </form>

  <div style="text-align: center; margin-top: 1rem;">
    <p><a href="{% url 'users:login' %}">Back to Login</a></p>
  </div>
</div>

{% if show_verification %}
<script>
  let countdownInterval;

  function startCountdown() {
    let timeLeft = 60;
    const countdownEl = document.getElementById('countdown');
    const verifyBtn = document.getElementById('verifyBtn');
    const codeInput = document.getElementById('id_verification_code');

    countdownInterval = setInterval(() => {
      timeLeft--;
      countdownEl.textContent = timeLeft;

      if (timeLeft <= 10) {
        countdownEl.style.color = '#ff6b6b';
      }

      if (timeLeft <= 0) {
        clearInterval(countdownInterval);
        countdownEl.textContent = 'EXPIRED';
        countdownEl.style.color = '#e74c3c';
        codeInput.disabled = true;
        verifyBtn.disabled = true;
        verifyBtn.textContent = 'Code Expired';

        // Show message
        const msg = document.createElement('div');
        msg.style.cssText = 'background: #e74c3c; color: white; padding: 1rem; border-radius: 8px; margin-top: 1rem; text-align: center;';
        msg.innerHTML = '‚ùå Verification code expired!<br><a href="{% url "users:forgot_password" %}" style="color: white; text-decoration: underline;">Request a new code</a>';
        document.getElementById('verificationSection').parentElement.insertBefore(msg, document.getElementById('verificationSection').nextSibling);
      }
    }, 1000);
  }

  // Start countdown when page loads
  document.addEventListener('DOMContentLoaded', function () {
    startCountdown();
  });
</script>
{% endif %}
{% endblock %}