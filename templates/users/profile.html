{% extends 'base.html' %}

{% block title %}Dashboard - CTF Platform{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
  <!-- Profile Photo - Above Dashboard -->
  <div
    style="padding: 0.75rem 1.5rem; display: flex; align-items: center; gap: 1rem; background: rgba(0,0,0,0.3); border-bottom: 2px solid #00ff88; margin-bottom: 0;">
    <div onclick="openProfileModal()" style="cursor: pointer;">
      {% if profile.profile_photo %}
      <img src="{{ profile.profile_photo.url }}" alt="Profile" class="profile-avatar"
        style="width: 70px; height: 70px; border-radius: 50%; object-fit: cover; border: 4px solid #00ff88; transition: transform 0.2s; box-shadow: 0 4px 12px rgba(0,255,136,0.5);"
        onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
      {% else %}
      <div
        style="width: 70px; height: 70px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; border: 4px solid #00ff88; transition: transform 0.2s; box-shadow: 0 4px 12px rgba(0,255,136,0.5);"
        onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
        üë§
      </div>
      {% endif %}
    </div>
    <div>
      <h2 style="margin: 0; color: #00ff88; font-size: 1.3rem;">{{ user.first_name }} {{ user.last_name }}</h2>
      <p style="margin: 0.25rem 0 0 0; color: #999;">Rank: #{{ user_rank }} | Score: {{ profile.total_score }}</p>
    </div>
  </div>

  <!-- Top Navigation Bar -->
  <div class="dashboard-navbar">
    <div class="navbar-left">
      <span class="navbar-logo">CTF</span>
      <div class="navbar-menu">
        <a href="{% url 'home' %}" class="navbar-item">Home</a>
        <a href="{% url 'challenges:list' %}" class="navbar-item">Challenges</a>
        <a href="{% url 'leaderboard:leaderboard' %}" class="navbar-item">Leaderboard</a>
        <a href="#" class="navbar-item">Rules</a>
      </div>
    </div>
    <div class="navbar-right">
      <div class="time-display" id="timeDisplay">00:00:00</div>
      <div class="profile-info" style="text-align: right;">
        <div class="profile-name">{{ user.first_name }} {{ user.last_name }}</div>
        <div class="profile-rank">Rank: #{{ user_rank }}</div>
      </div>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div class="dashboard-main">
    <!-- Left Sidebar -->
    <div class="dashboard-sidebar">
      <div class="sidebar-section">
        <div class="section-title">üìä Your Stats</div>
        <div class="stats-box">
          <div class="stat-item">
            <div class="stat-label">Total Points</div>
            <div class="stat-value">{{ profile.total_score }}</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Challenges Solved</div>
            <div class="stat-value">{{ profile.challenges_solved }}</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Your Rank</div>
            <div class="stat-value">#{{ user_rank }}</div>
          </div>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="section-title">üìà Recent Activity</div>
        <div class="activity-list">
          {% for submission in solved_challenges|slice:":5" %}
          <div class="activity-item">
            <div class="activity-text">{{ submission.challenge.title }}</div>
            <div class="activity-desc">{{ submission.challenge.get_category_display }}</div>
            <div class="activity-time">{{ submission.timestamp|date:"m-d H:i" }}</div>
          </div>
          {% empty %}
          <div class="activity-item">
            <div class="activity-text">No challenges solved yet</div>
            <div class="activity-desc">Start solving to see your progress</div>
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="sidebar-footer">
        <a href="{% url 'challenges:list' %}" class="btn-start-challenge">Start Challenge</a>
      </div>
    </div>

    <!-- Center Content -->
    <div class="dashboard-center">
      <!-- Category Grid -->
      <div class="category-grid">
        {% for category, stats in category_stats.items %}
        <div class="category-box {{ category }}">
          <div class="box-title">{{ stats.display_name|upper }}</div>
          <div class="box-icon">
            {% if category == 'web' %}üåê
            {% elif category == 'crypto' %}üîê
            {% elif category == 'forensics' %}üîç
            {% elif category == 'pwn' %}üí£
            {% elif category == 'reverse' %}üîÑ
            {% elif category == 'misc' %}‚öôÔ∏è
            {% endif %}
          </div>
          <div class="box-stats">
            <div>{{ stats.solved_challenges }}/{{ stats.total_challenges }} Questions</div>
            <div>Score: {{ stats.user_points }}/{{ stats.total_points }}</div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Bottom Cards -->
      <div class="bottom-cards">
        <!-- User Profile Card -->
        <div class="card profile-card">
          <div class="card-header profile-header">
            <span>üë§ Profile Info</span>
            <a href="{% url 'users:edit_profile' %}" class="btn btn-primary"
              style="padding: 0.5rem 1rem; font-size: 0.9rem;">‚úèÔ∏è Edit Profile</a>
          </div>
          <div class="card-body">
            {% if profile.profile_photo %}
            <div style="text-align: center; margin-bottom: 1rem;">
              <img src="{{ profile.profile_photo.url }}" alt="Profile Photo" onclick="openProfileModal()"
                style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid #00ff88; cursor: pointer; transition: transform 0.2s;"
                onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
            </div>
            {% endif %}
            {% if profile.bio %}
            <div class="profile-row"
              style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
              <span style="display: block; margin-bottom: 0.5rem; color: #00ff88;">Bio:</span>
              <span class="value" style="display: block; line-height: 1.6;">{{ profile.bio }}</span>
            </div>
            {% endif %}
            <div class="profile-row">
              <span>Username:</span>
              <span class="value">{{ user.username }}</span>
            </div>
            <div class="profile-row">
              <span>Email:</span>
              <span class="value">{{ user.email }}</span>
            </div>
            <div class="profile-row">
              <span>Education:</span>
              <span class="value">{{ profile.get_education_level_display|default:"N/A" }}</span>
            </div>
            <div class="profile-row">
              <span>Department:</span>
              <span class="value">{{ profile.get_department_display|default:"N/A" }}</span>
            </div>
          </div>
        </div>

        <!-- Statistics Card -->
        <div class="card stats-card">
          <div class="card-header stats-header">
            <span>üìä Statistics</span>
          </div>
          <div class="card-body">
            <div class="stat-row">
              <span>Total Score:</span>
              <span class="value">{{ profile.total_score }}</span>
            </div>
            <div class="stat-row">
              <span>Challenges Solved:</span>
              <span class="value">{{ profile.challenges_solved }}</span>
            </div>
            <div class="stat-row">
              <span>Current Rank:</span>
              <span class="value">#{{ user_rank }}</span>
            </div>
            <div class="stat-row">
              <span>Last Submission:</span>
              <span class="value">
                {% if profile.last_submission %}
                {{ profile.last_submission|date:"M d, Y" }}
                {% else %}
                Never
                {% endif %}
              </span>
            </div>
          </div>
        </div>

        <!-- Achievements Card -->
        <div class="card achievements-card">
          <div class="card-header achievements-header">
            <span>üèÜ Achievements</span>
          </div>
          <div class="card-body">
            {% if profile.challenges_solved >= 1 %}
            <div class="achievement">
              <span class="achievement-icon">ü•á</span>
              <span>First Challenge</span>
            </div>
            {% endif %}
            {% if profile.challenges_solved >= 5 %}
            <div class="achievement">
              <span class="achievement-icon">ü•à</span>
              <span>5 Challenges Solved</span>
            </div>
            {% endif %}
            {% if profile.challenges_solved >= 10 %}
            <div class="achievement">
              <span class="achievement-icon">ü•â</span>
              <span>10 Challenges Solved</span>
            </div>
            {% endif %}
            {% if profile.total_score >= 100 %}
            <div class="achievement">
              <span class="achievement-icon">‚≠ê</span>
              <span>100 Points Earned</span>
            </div>
            {% endif %}
            {% if user_rank <= 10 %} <div class="achievement">
              <span class="achievement-icon">üëë</span>
              <span>Top 10 Rank</span>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- Profile Photo Modal -->
<div id="profileModal"
  style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center;">
  <div style="position: relative; max-width: 90%; max-height: 90%;">
    <span onclick="closeProfileModal()"
      style="position: absolute; top: -40px; right: 0; color: white; font-size: 2rem; cursor: pointer; font-weight: bold;">&times;</span>
    {% if profile.profile_photo %}
    <img src="{{ profile.profile_photo.url }}" alt="Profile Photo"
      style="max-width: 100%; max-height: 80vh; border-radius: 10px; border: 3px solid #00ff88;">
    <div style="text-align: center; margin-top: 1rem;">
      <h2 style="color: white; margin-bottom: 0.5rem;">{{ user.first_name }} {{ user.last_name }}</h2>
      <p style="color: #00ff88;">@{{ user.username }}</p>
      {% if profile.bio %}
      <p style="color: #ccc; max-width: 600px; margin: 1rem auto;">{{ profile.bio }}</p>
      {% endif %}
      <a href="{% url 'users:edit_profile' %}" class="btn btn-primary"
        style="margin-top: 1rem; display: inline-block;">‚úèÔ∏è Edit Profile</a>
    </div>
    {% else %}
    <div style="text-align: center; color: white;">
      <div
        style="width: 300px; height: 300px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; margin: 0 auto; font-size: 10rem;">
        üë§
      </div>
      <h2 style="margin-top: 2rem;">{{ user.first_name }} {{ user.last_name }}</h2>
      <p style="color: #00ff88;">@{{ user.username }}</p>
      {% if profile.bio %}
      <p style="color: #ccc; max-width: 600px; margin: 1rem auto;">{{ profile.bio }}</p>
      {% endif %}
      <a href="{% url 'users:edit_profile' %}" class="btn btn-primary"
        style="margin-top: 1rem; display: inline-block;">‚úèÔ∏è Upload Photo</a>
    </div>
    {% endif %}
  </div>
</div>

<script>
  function updateTime() {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    document.getElementById('timeDisplay').textContent = `${hours}:${minutes}:${seconds}`;
  }
  updateTime();
  setInterval(updateTime, 1000);

  function openProfileModal() {
    const modal = document.getElementById('profileModal');
    modal.style.display = 'flex';
  }

  function closeProfileModal() {
    const modal = document.getElementById('profileModal');
    modal.style.display = 'none';
  }

  // Close modal when clicking outside the image
  document.getElementById('profileModal').addEventListener('click', function (e) {
    if (e.target === this) {
      closeProfileModal();
    }
  });

  // Close modal with Escape key
  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') {
      closeProfileModal();
    }
  });
</script>
{% endblock %}