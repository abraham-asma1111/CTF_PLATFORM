{% extends 'base.html' %}

{% block title %}Register - CTF Platform{% endblock %}

{% block content %}
<div class="card" style="max-width: 600px; margin: 0 auto;">
  <div class="card-header">
    <h1 class="card-title">üîê Register</h1>
    <p>Create your account to start solving challenges!</p>
  </div>

  <form method="post" id="registerForm">
    {% csrf_token %}

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
      <div class="form-group">
        <label for="id_first_name" class="form-label">First Name:</label>
        <input type="text" name="first_name" id="id_first_name" class="form-control" required>
      </div>

      <div class="form-group">
        <label for="id_last_name" class="form-label">Last Name:</label>
        <input type="text" name="last_name" id="id_last_name" class="form-control" required>
      </div>
    </div>

    <div class="form-group">
      <label for="id_email" class="form-label">Email:</label>
      <input type="email" name="email" id="id_email" class="form-control" required value="{{ email }}">
    </div>

    {% if show_verification %}
    <div class="form-group" id="verificationSection">
      <label for="id_verification_code" class="form-label">Verification Code:</label>
      <div
        style="background: rgba(0, 255, 136, 0.1); border: 1px solid #00ff88; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
        <p style="color: #00ff88; font-size: 0.9rem; margin: 0 0 0.5rem 0;">
          üìß A 6-digit verification code has been sent to <strong>{{ email }}</strong>
        </p>
        <p style="color: #ff6b6b; font-size: 0.9rem; margin: 0 0 0.5rem 0; font-weight: bold;">
          ‚è±Ô∏è Code expires in: <span id="countdown">60</span> seconds
        </p>
        <p style="color: #999; font-size: 0.85rem; margin: 0;">
          üí° <strong>Development Mode:</strong> Check your browser console or terminal for the code if email is not
          received.
        </p>
      </div>
      <div style="display: flex; gap: 0.5rem;">
        <input type="text" name="verification_code" id="id_verification_code" class="form-control" placeholder="000000"
          maxlength="6" pattern="[0-9]{6}" required style="flex: 1;">
        <button type="button" class="btn btn-primary" id="resendBtn" onclick="resendCode()"
          style="white-space: nowrap;">Resend
          Code</button>
      </div>
    </div>
    <button type="submit" class="btn btn-primary" id="verifyBtn" style="width: 100%; margin-bottom: 1rem;">Verify
      Email</button>
    {% else %}

    <div class="form-group">
      <label for="{{ form.username.id_for_label }}" class="form-label">Username:</label>
      <small style="color: #666; display: block; margin-bottom: 0.5rem;">Use letters (A-Z, a-z), numbers (0-9), and
        underscores (_) only. No spaces or special characters.</small>
      {{ form.username }}
      {% if form.username.errors %}
      <div class="alert alert-error">
        {% for error in form.username.errors %}
        <p>{{ error }}</p>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
      <div class="form-group">
        <label for="{{ form.password1.id_for_label }}" class="form-label">Password:</label>
        <div style="position: relative;">
          {{ form.password1 }}
          <span class="password-toggle" onclick="togglePassword('id_password1')"
            style="position: absolute; right: 10px; top: 38px; cursor: pointer; font-size: 1.2rem;">üëÅÔ∏è</span>
        </div>
        {% if form.password1.errors %}
        <div class="alert alert-error">
          {% for error in form.password1.errors %}
          <p>{{ error }}</p>
          {% endfor %}
        </div>
        {% endif %}
      </div>

      <div class="form-group">
        <label for="{{ form.password2.id_for_label }}" class="form-label">Confirm Password:</label>
        <div style="position: relative;">
          {{ form.password2 }}
          <span class="password-toggle" onclick="togglePassword('id_password2')"
            style="position: absolute; right: 10px; top: 38px; cursor: pointer; font-size: 1.2rem;">üëÅÔ∏è</span>
        </div>
        {% if form.password2.errors %}
        <div class="alert alert-error">
          {% for error in form.password2.errors %}
          <p>{{ error }}</p>
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
      <div class="form-group">
        <label for="id_sex" class="form-label">Sex:</label>
        <select name="sex" id="id_sex" class="form-control">
          <option value="">-- Select --</option>
          <option value="male">Male</option>
          <option value="female">Female</option>
          <option value="other">Other</option>
        </select>
      </div>

      <div class="form-group">
        <label for="id_education_level" class="form-label">Education Level:</label>
        <select name="education_level" id="id_education_level" class="form-control" onchange="toggleDepartment()">
          <option value="">-- Select --</option>
          <option value="high_school">High School</option>
          <option value="undergraduate">Undergraduate</option>
          <option value="postgraduate">Postgraduate</option>
        </select>
      </div>
    </div>

    <div class="form-group" id="departmentGroup" style="display: none;">
      <label for="id_department" class="form-label">Department:</label>
      <select name="department" id="id_department" class="form-control">
        <option value="">-- Select --</option>
        <option value="cyber_security">Cyber Security</option>
        <option value="software_engineering">Software Engineering</option>
        <option value="computer_science">Computer Science</option>
        <option value="it">Information Technology</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label">Verify you're human:</label>
      {{ form.captcha }}
      {% if form.captcha.errors %}
      <div class="alert alert-error">
        {% for error in form.captcha.errors %}
        <p>{{ error }}</p>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <button type="submit" class="btn btn-primary" style="width: 100%;">Register</button>
    {% endif %}
  </form>

  <div style="text-align: center; margin-top: 1rem;">
    <p>Already have an account? <a href="{% url 'users:login' %}">Login here</a></p>
  </div>
</div>

<script>
  function toggleDepartment() {
    const educationLevel = document.getElementById('id_education_level').value;
    const departmentGroup = document.getElementById('departmentGroup');

    if (educationLevel === 'undergraduate' || educationLevel === 'postgraduate') {
      departmentGroup.style.display = 'block';
    } else {
      departmentGroup.style.display = 'none';
    }
  }

  function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const icon = event.target;

    if (field.type === 'password') {
      field.type = 'text';
      icon.textContent = 'üôà';
    } else {
      field.type = 'password';
      icon.textContent = 'üëÅÔ∏è';
    }
  }

  let countdownInterval;

  function startCountdown() {
    let timeLeft = 60;
    const countdownEl = document.getElementById('countdown');
    const verifyBtn = document.getElementById('verifyBtn');
    const codeInput = document.getElementById('id_verification_code');

    countdownInterval = setInterval(() => {
      timeLeft--;
      countdownEl.textContent = timeLeft;

      if (timeLeft <= 10) {
        countdownEl.style.color = '#ff6b6b';
      }

      if (timeLeft <= 0) {
        clearInterval(countdownInterval);
        countdownEl.textContent = 'EXPIRED';
        countdownEl.style.color = '#e74c3c';
        codeInput.disabled = true;
        verifyBtn.disabled = true;
        verifyBtn.textContent = 'Code Expired - Request New Code';

        // Show message
        const msg = document.createElement('div');
        msg.style.cssText = 'background: #e74c3c; color: white; padding: 1rem; border-radius: 8px; margin-top: 1rem; text-align: center;';
        msg.textContent = '‚ùå Verification code expired! Please request a new code.';
        document.getElementById('verificationSection').parentElement.insertBefore(msg, document.getElementById('verificationSection').nextSibling);
      }
    }, 1000);
  }

  function resendCode() {
    const email = document.getElementById('id_email').value;
    const btn = event.target;

    if (!email) {
      alert('Please enter your email');
      return;
    }

    btn.disabled = true;
    btn.textContent = 'Sending...';

    fetch('/users/send-verification/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({ email: email })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Verification code sent! Check your email.');
          btn.textContent = 'Resend Code';
          btn.disabled = false;

          // Reset countdown
          clearInterval(countdownInterval);
          const countdownEl = document.getElementById('countdown');
          countdownEl.textContent = '60';
          countdownEl.style.color = '#ff6b6b';

          const codeInput = document.getElementById('id_verification_code');
          const verifyBtn = document.getElementById('verifyBtn');
          codeInput.disabled = false;
          codeInput.value = '';
          verifyBtn.disabled = false;
          verifyBtn.textContent = 'Verify Email';

          // Remove expired message if exists
          const expiredMsg = document.querySelector('[style*="background: #e74c3c"]');
          if (expiredMsg) expiredMsg.remove();

          startCountdown();
        } else {
          alert('Error: ' + data.message);
          btn.textContent = 'Resend Code';
          btn.disabled = false;
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Failed to send code');
        btn.textContent = 'Resend Code';
        btn.disabled = false;
      });
  }

  // Start countdown when page loads if verification section is visible
  document.addEventListener('DOMContentLoaded', function () {
    const verificationSection = document.getElementById('verificationSection');
    if (verificationSection) {
      startCountdown();
    }
  });
</script>
{% endblock %}