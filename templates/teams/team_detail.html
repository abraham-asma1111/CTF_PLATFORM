{% extends 'base.html' %}

{% block title %}{{ team.name }} - CTF Platform{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/teams.css">
{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="row mb-4">
    <div class="col-md-8">
      <h2 class="text-primary">üõ°Ô∏è {{ team.name }}</h2>
      <p class="text-muted">{{ team.description|default:"No description" }}</p>
    </div>
    <div class="col-md-4">
      <div class="team-nav-buttons">
        {% if is_captain %}
        <a href="{% url 'teams:team_management' team.id %}" class="btn-team warning">
          <i class="fas fa-cog"></i> Manage
        </a>
        {% endif %}
        {% if is_member %}
        <a href="{% url 'chat:team_chat' team.id %}" class="btn-team success" style="font-weight: bold;">
          <i class="fas fa-comments"></i> Chat
        </a>
        {% endif %}
        <a href="{% url 'teams:team_list' %}" class="btn-team primary">
          <i class="fas fa-arrow-left"></i> All Teams
        </a>
      </div>
    </div>
  </div>

  {% if not team.can_compete %}
  <div class="team-alert warning">
    <i class="fas fa-exclamation-triangle"></i> <strong>Warning:</strong> This team needs at least 2 members to compete!
  </div>
  {% endif %}

  <div class="row mb-4">
    <div class="col-md-3 mb-3">
      <div class="team-stat-card score">
        <h3>{{ team.total_score }}</h3>
        <p class="text-muted mb-0">Total Points</p>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="team-stat-card solved">
        <h3>{{ team.challenges_solved }}</h3>
        <p class="text-muted mb-0">Challenges Solved</p>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="team-stat-card members">
        <h3>{{ team.member_count }}</h3>
        <p class="text-muted mb-0">Members</p>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="team-stat-card max">
        <h3>{{ team.max_members }}</h3>
        <p class="text-muted mb-0">Max Members</p>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6">
      <div class="card member-list mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-users"></i> Team Members</h5>
        </div>
        <div class="card-body p-0">
          <ul class="list-group list-group-flush">
            {% for membership in members %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              {{ membership.user.username }}
              {% if membership.user == team.captain %}
              <span class="badge bg-warning text-dark">Captain</span>
              {% endif %}
            </li>
            {% empty %}
            <li class="list-group-item text-muted">No members yet</li>
            {% endfor %}
          </ul>
        </div>
      </div>

      {% if is_member %}
      <button class="btn btn-danger" id="leave-team-btn">
        <i class="fas fa-sign-out-alt"></i> Leave Team
      </button>
      {% elif not is_member and not has_pending_request and not team.is_full %}
      <button class="btn btn-success" id="join-team-btn">
        <i class="fas fa-user-plus"></i> Request to Join
      </button>
      {% elif has_pending_request %}
      <div class="alert alert-info">
        <i class="fas fa-clock"></i> Your join request is pending approval
        <button class="btn btn-sm btn-outline-danger ms-2" id="cancel-request-btn">
          <i class="fas fa-times"></i> Cancel Request
        </button>
      </div>
      {% elif team.is_full %}
      <div class="alert alert-warning">
        <i class="fas fa-users"></i> Team is full
      </div>
      {% endif %}
    </div>

    <div class="col-md-6">
      {% if is_captain %}
      <div class="card mb-4">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="fas fa-envelope"></i> Invite Members</h5>
        </div>
        <div class="card-body invite-form">
          <form id="invite-form">
            <div class="mb-3">
              <label for="invite-email" class="form-label">User Email</label>
              <input type="email" class="form-control" id="invite-email" placeholder="user@example.com" required>
              <small class="form-text text-muted">Enter the email of a registered user</small>
            </div>
            <div class="mb-3">
              <label for="invite-message" class="form-label">Message (Optional)</label>
              <textarea class="form-control" id="invite-message" rows="2" placeholder="Join our team!"></textarea>
            </div>
            <button type="submit" class="btn btn-success">
              <i class="fas fa-paper-plane"></i> Send Invitation
            </button>
          </form>
        </div>
      </div>

      {% if pending_requests %}
      <div class="card">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0"><i class="fas fa-clock"></i> Pending Requests</h5>
        </div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            {% for request in pending_requests %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              {{ request.user.username }}
              <div>
                <button class="btn btn-sm btn-success approve-btn" data-membership-id="{{ request.id }}">
                  <i class="fas fa-check"></i> Approve
                </button>
                <button class="btn btn-sm btn-danger reject-btn" data-membership-id="{{ request.id }}">
                  <i class="fas fa-times"></i> Reject
                </button>
              </div>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>
      {% endif %}
      {% endif %}
    </div>
  </div>
</div>

<script>
  // Send invitation
  const inviteForm = document.getElementById('invite-form');
  if (inviteForm) {
    inviteForm.addEventListener('submit', function (e) {
      e.preventDefault();
      const email = document.getElementById('invite-email').value;
      const message = document.getElementById('invite-message').value;

      fetch(`/teams/{{ team.id }}/invite/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          email: email,
          message: message
        })
      })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          if (data.success) {
            document.getElementById('invite-email').value = '';
            document.getElementById('invite-message').value = '';
          }
        });
    });
  }

  // Join team
  const joinBtn = document.getElementById('join-team-btn');
  if (joinBtn) {
    joinBtn.addEventListener('click', function () {
      fetch(`/teams/{{ team.id }}/join/`, {
        method: 'POST'
      })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          if (data.success) location.reload();
        });
    });
  }

  // Cancel join request
  const cancelRequestBtn = document.getElementById('cancel-request-btn');
  if (cancelRequestBtn) {
    cancelRequestBtn.addEventListener('click', function () {
      if (confirm('Cancel your join request?')) {
        fetch('/teams/cancel-request/', {
          method: 'POST'
        })
          .then(response => response.json())
          .then(data => {
            alert(data.message);
            if (data.success) location.reload();
          });
      }
    });
  }

  // Leave team
  const leaveBtn = document.getElementById('leave-team-btn');
  if (leaveBtn) {
    leaveBtn.addEventListener('click', function () {
      if (confirm('Are you sure you want to leave this team?')) {
        fetch('/teams/leave/', {
          method: 'POST'
        })
          .then(response => response.json())
          .then(data => {
            alert(data.message);
            if (data.success) window.location.href = '/teams/';
          });
      }
    });
  }

  // Approve member
  document.querySelectorAll('.approve-btn').forEach(btn => {
    btn.addEventListener('click', function () {
      const membershipId = this.dataset.membershipId;
      fetch(`/teams/membership/${membershipId}/approve/`, {
        method: 'POST'
      })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          if (data.success) location.reload();
        });
    });
  });

  // Reject member
  document.querySelectorAll('.reject-btn').forEach(btn => {
    btn.addEventListener('click', function () {
      const membershipId = this.dataset.membershipId;
      fetch(`/teams/membership/${membershipId}/reject/`, {
        method: 'POST'
      })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          if (data.success) location.reload();
        });
    });
  });
</script>
{% endblock %}