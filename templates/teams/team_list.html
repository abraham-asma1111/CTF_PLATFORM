{% extends 'base.html' %}

{% block title %}Teams - CTF Platform{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/teams.css">
{% endblock %}

{% block content %}
<div class="container mt-5">
  <!-- Group Event Information Section -->
  {% if is_group_mode_active and group_event_details %}
  <div class="group-event-info-section">
    <div class="group-event-header">
      <div class="event-icon">ğŸ†</div>
      <div class="event-details">
        <h2 class="event-name">{{ group_event_details.name }}</h2>
        <p class="event-description">{{ group_event_details.description }}</p>
      </div>
      <div class="event-status">
        <span class="status-badge active">ğŸ”´ LIVE</span>
      </div>
    </div>
    
    <div class="group-event-stats-grid">
      <div class="stat-card">
        <div class="stat-icon">ğŸ¯</div>
        <div class="stat-content">
          <div class="stat-number">{{ group_event_details.total_challenges }}</div>
          <div class="stat-label">Group Challenges</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ğŸ‘¥</div>
        <div class="stat-content">
          <div class="stat-number">{{ group_event_details.total_teams }}</div>
          <div class="stat-label">Teams Competing</div>
        </div>
      </div>
      {% if group_event_details.point_multiplier != 1.0 %}
      <div class="stat-card">
        <div class="stat-icon">âš¡</div>
        <div class="stat-content">
          <div class="stat-number">{{ group_event_details.point_multiplier }}x</div>
          <div class="stat-label">Points Multiplier</div>
        </div>
      </div>
      {% endif %}
      {% if group_event_details.max_teams %}
      <div class="stat-card">
        <div class="stat-icon">ğŸ</div>
        <div class="stat-content">
          <div class="stat-number">{{ group_event_details.max_teams }}</div>
          <div class="stat-label">Max Teams</div>
        </div>
      </div>
      {% endif %}
    </div>

    {% if not user_team %}
    <div class="participation-prompt">
      <div class="prompt-content">
        <h3>ğŸš€ Ready to Compete?</h3>
        <p>Join or create a team to participate in the group competition and access exclusive group challenges!</p>
        <div class="prompt-actions">
          <a href="#teams-section" class="btn-prompt primary" onclick="scrollToTeams()">
            <i class="icon">ğŸ‘¥</i>
            Browse Teams
          </a>
          <a href="{% url 'teams:create_team' %}" class="btn-prompt secondary">
            <i class="icon">â•</i>
            Create New Team
          </a>
        </div>
      </div>
    </div>
    {% else %}
    <div class="team-status-info">
      <div class="status-content">
        <h3>âœ… You're Ready to Compete!</h3>
        <p>You're part of <strong>{{ user_team.name }}</strong>. Access group challenges and compete with your team!</p>
        <a href="{% url 'teams:my_team' %}" class="btn-prompt primary">
          <i class="icon">ğŸ›¡ï¸</i>
          Go to Team Dashboard
        </a>
      </div>
    </div>
    {% endif %}
  </div>
  {% endif %}

  <div class="row mb-4" id="teams-section">
    <div class="col-md-8">
      <h2 class="text-primary">ğŸ›¡ï¸ Teams</h2>
      <p class="text-muted">
        {% if is_group_mode_active %}
          Join a team to participate in the active group competition
        {% else %}
          Join a team or create your own to compete together
        {% endif %}
      </p>
    </div>
    <div class="col-md-4">
      <div class="team-nav-buttons">
        <a href="{% url 'teams:team_leaderboard' %}" class="btn-team primary">
          <i class="fas fa-trophy"></i> Leaderboard
        </a>
        {% if user_membership %}
        <a href="{% url 'teams:my_team' %}" class="btn-team success">
          <i class="fas fa-users"></i> My Team
        </a>
        {% else %}
        <a href="{% url 'teams:create_team' %}" class="btn-team success">
          <i class="fas fa-plus"></i> Create Team
        </a>
        {% endif %}
      </div>
    </div>
    </a>
  </div>
</div>

{% if user_membership %}
<div class="team-alert success">
  <i class="fas fa-users"></i> You are currently in team: <strong>{{ user_membership.team.name }}</strong>
  <br>
  <small>You cannot join or create another team unless you leave your current team.</small>
</div>
{% else %}
<div class="team-alert info">
  <i class="fas fa-info-circle"></i> You are not in a team yet.
  <a href="{% url 'teams:my_invitations' %}" class="text-decoration-none" style="color: #00ff88;">
    <strong>Check your invitations</strong>
  </a> or create/join a team below.

  {% if pending_requests %}
  <br><br>
  <strong>Your pending requests:</strong>
  <div class="mt-2">
    {% for request in pending_requests %}
    <div class="d-inline-flex align-items-center me-3 mb-2">
      <span class="badge bg-warning text-dark me-2">{{ request.team.name }}</span>
      <button class="btn btn-sm btn-outline-danger cancel-request-btn" data-team-name="{{ request.team.name }}"
        title="Cancel request">
        <i class="fas fa-times"></i>
      </button>
    </div>
    {% endfor %}
  </div>
  {% endif %}
</div>
{% endif %}

<div class="row">
  {% for team in teams %}
  <div class="col-md-6 mb-4">
    <div class="card team-card h-100 {% if team.can_compete %}competing{% else %}needs-members{% endif %}">
      <div class="card-body">
        <h5 class="card-title">
          ğŸ›¡ï¸ {{ team.name }}
          {% if team.can_compete %}
          <span class="team-badge competing">âœ“ Competing</span>
          {% else %}
          <span class="team-badge needs-members">âš  Needs Members</span>
          {% endif %}
        </h5>
        <p class="card-text text-muted">{{ team.description|default:"No description" }}</p>

        <div class="team-stats">
          <span class="stat-badge members">
            <i class="fas fa-users"></i> {{ team.member_count }}/{{ team.max_members }}
          </span>
          <span class="stat-badge score">
            <i class="fas fa-star"></i> {{ team.total_score }} pts
          </span>
          <span class="stat-badge solved">
            <i class="fas fa-flag"></i> {{ team.challenges_solved }} solved
          </span>
        </div>

        <p class="mb-3">
          <strong style="color: #00ff88;">Captain:</strong>
          <span class="badge bg-primary">ğŸ‘¤ {{ team.captain.username }}</span>
        </p>

        <div class="d-flex gap-2 flex-wrap">
          <a href="{% url 'teams:team_detail' team.id %}" class="btn btn-sm btn-team primary">
            <i class="fas fa-info-circle"></i> View Details
          </a>

          {% if not user_membership and not team.is_full and team.captain != user %}
          <button class="btn btn-sm btn-team success join-team-btn" data-team-id="{{ team.id }}">
            <i class="fas fa-user-plus"></i> Request to Join
          </button>
          {% elif team.is_full %}
          <button class="btn btn-sm btn-secondary" disabled>
            <i class="fas fa-lock"></i> Full
          </button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% empty %}
  <div class="col-12">
    <div class="alert alert-info">
      No teams yet. Be the first to create one!
    </div>
  </div>
  {% endfor %}
</div>
</div>

<script>
  document.querySelectorAll('.join-team-btn').forEach(btn => {
    btn.addEventListener('click', function () {
      const teamId = this.dataset.teamId;

      fetch(`/teams/${teamId}/join/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert(data.message);
            location.reload();
          } else {
            alert(data.message);
          }
        });
    });
  });

  // Cancel join request
  document.querySelectorAll('.cancel-request-btn').forEach(btn => {
    btn.addEventListener('click', function () {
      const teamName = this.dataset.teamName;

      if (confirm(`Are you sure you want to cancel your request to join "${teamName}"?`)) {
        fetch('/teams/cancel-request/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        })
          .then(response => response.json())
          .then(data => {
            alert(data.message);
            if (data.success) {
              location.reload();
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while canceling the request.');
          });
      }
    });
  });

  // Smooth scroll to teams section
  function scrollToTeams() {
    document.getElementById('teams-section').scrollIntoView({
      behavior: 'smooth',
      block: 'start'
    });
  }
</script>
{% endblock %}